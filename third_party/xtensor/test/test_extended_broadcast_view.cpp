/***************************************************************************
* Copyright (c) 2016, Johan Mabille, Sylvain Corlay and Wolf Vollprecht    *
*                                                                          *
* Distributed under the terms of the BSD 3-Clause License.                 *
*                                                                          *
* The full license is in the file LICENSE, distributed with this software. *
****************************************************************************/

// This file is generated from test/files/cppy_source/test_extended_broadcast_view.cppy by preprocess.py!

#include <algorithm>

#include "gtest/gtest.h"
#include "xtensor/xarray.hpp"
#include "xtensor/xfixed.hpp"
#include "xtensor/xnoalias.hpp"
#include "xtensor/xstrided_view.hpp"
#include "xtensor/xtensor.hpp"
#include "xtensor/xview.hpp"

namespace xt
{
    using namespace xt::placeholders;

    /*py
    a = np.arange(35, dtype=np.float64).reshape(5, 7)
    */
    TEST(xtest_extended, negative_slices_twod)
    {
        // py_a
        xarray<double> py_a = {{ 0., 1., 2., 3., 4., 5., 6.},
                               { 7., 8., 9.,10.,11.,12.,13.},
                               {14.,15.,16.,17.,18.,19.,20.},
                               {21.,22.,23.,24.,25.,26.,27.},
                               {28.,29.,30.,31.,32.,33.,34.}};
        // py_av0 = a[:-2, ::-1]
        xarray<double> py_av0 = {{ 6., 5., 4., 3., 2., 1., 0.},
                                 {13.,12.,11.,10., 9., 8., 7.},
                                 {20.,19.,18.,17.,16.,15.,14.}};
        auto av0 = xt::strided_view(py_a, {_r|_|-2, _r|_|_|-1});
        EXPECT_EQ(av0, py_av0);
        // py_av1 = a[::-1, ::-1]
        xarray<double> py_av1 = {{34.,33.,32.,31.,30.,29.,28.},
                                 {27.,26.,25.,24.,23.,22.,21.},
                                 {20.,19.,18.,17.,16.,15.,14.},
                                 {13.,12.,11.,10., 9., 8., 7.},
                                 { 6., 5., 4., 3., 2., 1., 0.}};
        auto av1 = xt::strided_view(py_a, {_r|_|_|-1, _r|_|_|-1});
        EXPECT_EQ(av1, py_av1);
        // py_av2 = a[1:-3, -3:2:-1]
        xarray<double> py_av2 = {{11.,10.}};
        auto av2 = xt::strided_view(py_a, {_r|1|-3, _r|-3|2|-1});
        EXPECT_EQ(av2, py_av2);
        // py_av3 = a[-1:-4:-1, -3:1:-2]
        xarray<double> py_av3 = {{32.,30.},
                                 {25.,23.},
                                 {18.,16.}};
        auto av3 = xt::strided_view(py_a, {_r|-1|-4|-1, _r|-3|1|-2});
        EXPECT_EQ(av3, py_av3);
        auto av4 = xt::strided_view(py_a, {_r|-3|-5, _r|-3|10});
        EXPECT_EQ(av4.size(), 0);
        // py_av5 = a[-5:-2, -3:10]
        xarray<double> py_av5 = {{ 4., 5., 6.},
                                 {11.,12.,13.},
                                 {18.,19.,20.}};
        auto av5 = xt::strided_view(py_a, {_r|-5|-2, _r|-3|10});
        EXPECT_EQ(av5, py_av5);
    }

    /*py
    a0 = np.arange(35).reshape(5, 7)
    a = np.copy(a0)
    a[0:-2] += a[:3:-1]
    at = np.copy(a)
    at[::-2] += at[::2]
    */
    TEST(xtest_extended, negative_slices_math)
    {
        // py_a0
        xarray<long> py_a0 = {{ 0, 1, 2, 3, 4, 5, 6},
                              { 7, 8, 9,10,11,12,13},
                              {14,15,16,17,18,19,20},
                              {21,22,23,24,25,26,27},
                              {28,29,30,31,32,33,34}};
        strided_view(py_a0, {_r|0|-2}) += strided_view(py_a0, {{_r|_|3|-1}});
        // py_a
        xarray<long> py_a = {{28,30,32,34,36,38,40},
                             {35,37,39,41,43,45,47},
                             {42,44,46,48,50,52,54},
                             {21,22,23,24,25,26,27},
                             {28,29,30,31,32,33,34}};
        EXPECT_EQ(py_a0, py_a);
        strided_view(py_a0, {_r|_|_|-2}) += strided_view(py_a0, {_r|_|_|2});
        // py_at
        xarray<long> py_at = {{ 56, 59, 62, 65, 68, 71, 74},
                              { 35, 37, 39, 41, 43, 45, 47},
                              { 84, 88, 92, 96,100,104,108},
                              { 21, 22, 23, 24, 25, 26, 27},
                              { 56, 59, 62, 65, 68, 71, 74}};
        EXPECT_EQ(py_a0, py_at);
    }

    /*py
    a1 = np.arange(35).reshape(5, 1, 7)
    a2 = np.copy(a).reshape(1, 5, 1, 7)
    a3 = np.array([6,2,3,5,1]).reshape(1, 5, 1, 1)
    a1_a2 = a1 + a2
    b1 = np.arange(7)
    b1_a1 = a1 + b1
    b2 = np.copy(b1).reshape(1, 1, 1, 7)
    a1_b2 = a1 + b2
    b3 = np.random.random((2, 5, 4, 7))
    a2_b3 = a2 + b3
    */
    TEST(xtest_extended, broadcasting)
    {
        // py_a1
        xarray<long> py_a1 = {{{ 0, 1, 2, 3, 4, 5, 6}},
                             
                              {{ 7, 8, 9,10,11,12,13}},
                             
                              {{14,15,16,17,18,19,20}},
                             
                              {{21,22,23,24,25,26,27}},
                             
                              {{28,29,30,31,32,33,34}}};
        // py_a2
        xarray<long> py_a2 = {{{{28,30,32,34,36,38,40}},
                             
                               {{35,37,39,41,43,45,47}},
                             
                               {{42,44,46,48,50,52,54}},
                             
                               {{21,22,23,24,25,26,27}},
                             
                               {{28,29,30,31,32,33,34}}}};
        // py_b1
        xarray<long> py_b1 = {0,1,2,3,4,5,6};
        // py_b2
        xarray<long> py_b2 = {{{{0,1,2,3,4,5,6}}}};
        // py_b3
        xarray<double> py_b3 = {{{{0.02196058,0.03090541,0.0509559 ,0.13578779,0.2621239 ,0.03841174,
                                   0.4321603 },
                                  {0.79306472,0.53633471,0.99579399,0.61003783,0.76252648,0.44190752,
                                   0.92194683},
                                  {0.3749485 ,0.34670722,0.55977045,0.83034453,0.07289422,0.09788614,
                                   0.86943318},
                                  {0.85181698,0.1402997 ,0.09694383,0.85838645,0.73906301,0.16229588,
                                   0.12280526}},
                               
                                 {{0.54658731,0.20234206,0.02658424,0.03188794,0.38794816,0.73886801,
                                   0.93591371},
                                  {0.53799477,0.16783882,0.60314496,0.55401096,0.62039766,0.74603134,
                                   0.14618463},
                                  {0.88202933,0.11511608,0.29152543,0.90413445,0.86198639,0.56577174,
                                   0.57230904},
                                  {0.28876937,0.06313351,0.29416295,0.12916671,0.17694833,0.03750801,
                                   0.31184571}},
                               
                                 {{0.95466115,0.00788547,0.02286845,0.30679917,0.87133768,0.70645147,
                                   0.30053452},
                                  {0.69535861,0.63516063,0.26686566,0.59462713,0.59649361,0.80764438,
                                   0.60620554},
                                  {0.46386577,0.62019246,0.74568491,0.2385332 ,0.28042911,0.23440101,
                                   0.80643456},
                                  {0.97958218,0.08427462,0.23481661,0.25184391,0.45565352,0.51935155,
                                   0.9714147 }},
                               
                                 {{0.28594862,0.63942019,0.7434464 ,0.83879775,0.49578879,0.44473494,
                                   0.15885406},
                                  {0.82957768,0.67252167,0.09245468,0.87140763,0.96267842,0.41099328,
                                   0.944119  },
                                  {0.00112757,0.32087817,0.38053471,0.91664025,0.39223669,0.4812274 ,
                                   0.9246044 },
                                  {0.85580421,0.55342109,0.03698768,0.0483546 ,0.38707378,0.74386978,
                                   0.14783526}},
                               
                                 {{0.30158687,0.16938915,0.14202173,0.78143775,0.42556659,0.83783273,
                                   0.89519561},
                                  {0.87161443,0.88692617,0.31419571,0.78458209,0.56335561,0.81886726,
                                   0.06555234},
                                  {0.41484095,0.61635761,0.55903811,0.94566837,0.30346277,0.18960007,
                                   0.09232182},
                                  {0.77689717,0.18150293,0.88718695,0.85043958,0.80016809,0.202089  ,
                                   0.27705377}}},
                               
                               
                                {{{0.82463539,0.81879818,0.21043115,0.66873801,0.66403594,0.93360282,
                                   0.78354575},
                                  {0.17233007,0.16185663,0.79101426,0.19100661,0.81457013,0.74304839,
                                   0.95598639},
                                  {0.18298566,0.08019782,0.10211704,0.64482944,0.99701563,0.67531599,
                                   0.77287939},
                                  {0.22553485,0.35943884,0.95117927,0.03473884,0.2590158 ,0.43221734,
                                   0.07231832}},
                               
                                 {{0.9186931 ,0.18620905,0.05001197,0.59817721,0.71789988,0.58389808,
                                   0.40828624},
                                  {0.10155235,0.74157176,0.84527593,0.51253243,0.72673218,0.39987351,
                                   0.77094915},
                                  {0.4992255 ,0.27792041,0.51512403,0.35995207,0.67660387,0.17133459,
                                   0.93246326},
                                  {0.60651443,0.20115266,0.71760801,0.32709847,0.21483757,0.78953337,
                                   0.08955154}},
                               
                                 {{0.38217359,0.72497418,0.08770198,0.04014594,0.05422164,0.55297213,
                                   0.75925026},
                                  {0.9185571 ,0.87524313,0.55734968,0.23343945,0.68387789,0.04223554,
                                   0.73385613},
                                  {0.36264378,0.2539215 ,0.11672828,0.29175867,0.45408969,0.140941  ,
                                   0.38788636},
                                  {0.64557527,0.3266981 ,0.71952936,0.70558368,0.07118342,0.47975909,
                                   0.7986307 }},
                               
                                 {{0.27194818,0.47323025,0.40035767,0.12721217,0.85200716,0.25138674,
                                   0.05666355},
                                  {0.5654188 ,0.8984974 ,0.74842885,0.77757126,0.72479314,0.72763179,
                                   0.68355897},
                                  {0.43610011,0.11152507,0.2254877 ,0.56638247,0.62390378,0.87413211,
                                   0.42572   },
                                  {0.26087212,0.66932786,0.4145346 ,0.78778357,0.21769483,0.26250146,
                                   0.89972037}},
                               
                                 {{0.43638304,0.35191346,0.31543792,0.52777761,0.9629939 ,0.37628879,
                                   0.40732524},
                                  {0.90204043,0.3286059 ,0.00679845,0.36231705,0.71251254,0.2669955 ,
                                   0.46230714},
                                  {0.22396499,0.55843655,0.54280855,0.67646516,0.82991742,0.17426503,
                                   0.7906973 },
                                  {0.61334344,0.36682175,0.43825981,0.50861131,0.51464589,0.18247998,
                                   0.02639622}}}};
        xt::xarray<long> a1_a2 = py_a1 + py_a2;
        // py_a1_a2
        xarray<long> py_a1_a2 = {{{{28,31,34,37,40,43,46}},
                                
                                  {{42,45,48,51,54,57,60}},
                                
                                  {{56,59,62,65,68,71,74}},
                                
                                  {{42,44,46,48,50,52,54}},
                                
                                  {{56,58,60,62,64,66,68}}}};
        EXPECT_EQ(a1_a2, py_a1_a2);

        xt::xarray<long> b1_a1 = py_b1 + py_a1;
        // py_b1_a1
        xarray<long> py_b1_a1 = {{{ 0, 2, 4, 6, 8,10,12}},
                                
                                 {{ 7, 9,11,13,15,17,19}},
                                
                                 {{14,16,18,20,22,24,26}},
                                
                                 {{21,23,25,27,29,31,33}},
                                
                                 {{28,30,32,34,36,38,40}}};
        EXPECT_EQ(b1_a1, py_b1_a1);

        xt::xarray<long> a1_b2 = py_a1 + py_b2;
        // py_a1_b2
        xarray<long> py_a1_b2 = {{{{ 0, 2, 4, 6, 8,10,12}},
                                
                                  {{ 7, 9,11,13,15,17,19}},
                                
                                  {{14,16,18,20,22,24,26}},
                                
                                  {{21,23,25,27,29,31,33}},
                                
                                  {{28,30,32,34,36,38,40}}}};
        EXPECT_EQ(a1_b2, py_a1_b2);

        xt::xarray<double> a2_b3 = xt::cast<double>(py_a2) + py_b3;
        // py_a2_b3
        xarray<double> py_a2_b3 = {{{{28.02196058,30.03090541,32.0509559 ,34.13578779,36.2621239 ,
                                      38.03841174,40.4321603 },
                                     {28.79306472,30.53633471,32.99579399,34.61003783,36.76252648,
                                      38.44190752,40.92194683},
                                     {28.3749485 ,30.34670722,32.55977045,34.83034453,36.07289422,
                                      38.09788614,40.86943318},
                                     {28.85181698,30.1402997 ,32.09694383,34.85838645,36.73906301,
                                      38.16229588,40.12280526}},
                                  
                                    {{35.54658731,37.20234206,39.02658424,41.03188794,43.38794816,
                                      45.73886801,47.93591371},
                                     {35.53799477,37.16783882,39.60314496,41.55401096,43.62039766,
                                      45.74603134,47.14618463},
                                     {35.88202933,37.11511608,39.29152543,41.90413445,43.86198639,
                                      45.56577174,47.57230904},
                                     {35.28876937,37.06313351,39.29416295,41.12916671,43.17694833,
                                      45.03750801,47.31184571}},
                                  
                                    {{42.95466115,44.00788547,46.02286845,48.30679917,50.87133768,
                                      52.70645147,54.30053452},
                                     {42.69535861,44.63516063,46.26686566,48.59462713,50.59649361,
                                      52.80764438,54.60620554},
                                     {42.46386577,44.62019246,46.74568491,48.2385332 ,50.28042911,
                                      52.23440101,54.80643456},
                                     {42.97958218,44.08427462,46.23481661,48.25184391,50.45565352,
                                      52.51935155,54.9714147 }},
                                  
                                    {{21.28594862,22.63942019,23.7434464 ,24.83879775,25.49578879,
                                      26.44473494,27.15885406},
                                     {21.82957768,22.67252167,23.09245468,24.87140763,25.96267842,
                                      26.41099328,27.944119  },
                                     {21.00112757,22.32087817,23.38053471,24.91664025,25.39223669,
                                      26.4812274 ,27.9246044 },
                                     {21.85580421,22.55342109,23.03698768,24.0483546 ,25.38707378,
                                      26.74386978,27.14783526}},
                                  
                                    {{28.30158687,29.16938915,30.14202173,31.78143775,32.42556659,
                                      33.83783273,34.89519561},
                                     {28.87161443,29.88692617,30.31419571,31.78458209,32.56335561,
                                      33.81886726,34.06555234},
                                     {28.41484095,29.61635761,30.55903811,31.94566837,32.30346277,
                                      33.18960007,34.09232182},
                                     {28.77689717,29.18150293,30.88718695,31.85043958,32.80016809,
                                      33.202089  ,34.27705377}}},
                                  
                                  
                                   {{{28.82463539,30.81879818,32.21043115,34.66873801,36.66403594,
                                      38.93360282,40.78354575},
                                     {28.17233007,30.16185663,32.79101426,34.19100661,36.81457013,
                                      38.74304839,40.95598639},
                                     {28.18298566,30.08019782,32.10211704,34.64482944,36.99701563,
                                      38.67531599,40.77287939},
                                     {28.22553485,30.35943884,32.95117927,34.03473884,36.2590158 ,
                                      38.43221734,40.07231832}},
                                  
                                    {{35.9186931 ,37.18620905,39.05001197,41.59817721,43.71789988,
                                      45.58389808,47.40828624},
                                     {35.10155235,37.74157176,39.84527593,41.51253243,43.72673218,
                                      45.39987351,47.77094915},
                                     {35.4992255 ,37.27792041,39.51512403,41.35995207,43.67660387,
                                      45.17133459,47.93246326},
                                     {35.60651443,37.20115266,39.71760801,41.32709847,43.21483757,
                                      45.78953337,47.08955154}},
                                  
                                    {{42.38217359,44.72497418,46.08770198,48.04014594,50.05422164,
                                      52.55297213,54.75925026},
                                     {42.9185571 ,44.87524313,46.55734968,48.23343945,50.68387789,
                                      52.04223554,54.73385613},
                                     {42.36264378,44.2539215 ,46.11672828,48.29175867,50.45408969,
                                      52.140941  ,54.38788636},
                                     {42.64557527,44.3266981 ,46.71952936,48.70558368,50.07118342,
                                      52.47975909,54.7986307 }},
                                  
                                    {{21.27194818,22.47323025,23.40035767,24.12721217,25.85200716,
                                      26.25138674,27.05666355},
                                     {21.5654188 ,22.8984974 ,23.74842885,24.77757126,25.72479314,
                                      26.72763179,27.68355897},
                                     {21.43610011,22.11152507,23.2254877 ,24.56638247,25.62390378,
                                      26.87413211,27.42572   },
                                     {21.26087212,22.66932786,23.4145346 ,24.78778357,25.21769483,
                                      26.26250146,27.89972037}},
                                  
                                    {{28.43638304,29.35191346,30.31543792,31.52777761,32.9629939 ,
                                      33.37628879,34.40732524},
                                     {28.90204043,29.3286059 ,30.00679845,31.36231705,32.71251254,
                                      33.2669955 ,34.46230714},
                                     {28.22396499,29.55843655,30.54280855,31.67646516,32.82991742,
                                      33.17426503,34.7906973 },
                                     {28.61334344,29.36682175,30.43825981,31.50861131,32.51464589,
                                      33.18247998,34.02639622}}}};
        EXPECT_TRUE(xt::allclose(a2_b3, py_a2_b3));
    }

    /*py
    a0 = np.arange(5 * 3 * 7).reshape(5, 3, 7)
    a1 = np.copy(a0)
    b1 = np.arange(5 * 3).reshape(5, 3)
    a1[:, :, 2] = b1
    a2 = np.copy(a1)
    ar2 = np.arange(35).reshape(5, 1, 7)
    a1[:, 0, np.newaxis, :] = ar2
    a3 = np.copy(a1)
    a1[:, 2, :] = np.arange(7)
    a4 = np.copy(a1)
    */
    TEST(xtest_extended, broadcast_into_view)
    {
        // py_a0
        xarray<long> py_a0 = {{{  0,  1,  2,  3,  4,  5,  6},
                               {  7,  8,  9, 10, 11, 12, 13},
                               { 14, 15, 16, 17, 18, 19, 20}},
                             
                              {{ 21, 22, 23, 24, 25, 26, 27},
                               { 28, 29, 30, 31, 32, 33, 34},
                               { 35, 36, 37, 38, 39, 40, 41}},
                             
                              {{ 42, 43, 44, 45, 46, 47, 48},
                               { 49, 50, 51, 52, 53, 54, 55},
                               { 56, 57, 58, 59, 60, 61, 62}},
                             
                              {{ 63, 64, 65, 66, 67, 68, 69},
                               { 70, 71, 72, 73, 74, 75, 76},
                               { 77, 78, 79, 80, 81, 82, 83}},
                             
                              {{ 84, 85, 86, 87, 88, 89, 90},
                               { 91, 92, 93, 94, 95, 96, 97},
                               { 98, 99,100,101,102,103,104}}};
        xt::xarray<long> a = py_a0;

        // py_b1
        xarray<long> py_b1 = {{ 0, 1, 2},
                              { 3, 4, 5},
                              { 6, 7, 8},
                              { 9,10,11},
                              {12,13,14}};
        // py_a2
        xarray<long> py_a2 = {{{  0,  1,  0,  3,  4,  5,  6},
                               {  7,  8,  1, 10, 11, 12, 13},
                               { 14, 15,  2, 17, 18, 19, 20}},
                             
                              {{ 21, 22,  3, 24, 25, 26, 27},
                               { 28, 29,  4, 31, 32, 33, 34},
                               { 35, 36,  5, 38, 39, 40, 41}},
                             
                              {{ 42, 43,  6, 45, 46, 47, 48},
                               { 49, 50,  7, 52, 53, 54, 55},
                               { 56, 57,  8, 59, 60, 61, 62}},
                             
                              {{ 63, 64,  9, 66, 67, 68, 69},
                               { 70, 71, 10, 73, 74, 75, 76},
                               { 77, 78, 11, 80, 81, 82, 83}},
                             
                              {{ 84, 85, 12, 87, 88, 89, 90},
                               { 91, 92, 13, 94, 95, 96, 97},
                               { 98, 99, 14,101,102,103,104}}};
        view(a, all(), all(), 2) = py_b1;
        EXPECT_EQ(a, py_a2);

        // py_ar2
        xarray<long> py_ar2 = {{{ 0, 1, 2, 3, 4, 5, 6}},
                              
                               {{ 7, 8, 9,10,11,12,13}},
                              
                               {{14,15,16,17,18,19,20}},
                              
                               {{21,22,23,24,25,26,27}},
                              
                               {{28,29,30,31,32,33,34}}};
        xt::xarray<long> ar2 = py_ar2;
        view(a, all(), 0, newaxis(), all()) = ar2;

        // py_a3
        xarray<long> py_a3 = {{{  0,  1,  2,  3,  4,  5,  6},
                               {  7,  8,  1, 10, 11, 12, 13},
                               { 14, 15,  2, 17, 18, 19, 20}},
                             
                              {{  7,  8,  9, 10, 11, 12, 13},
                               { 28, 29,  4, 31, 32, 33, 34},
                               { 35, 36,  5, 38, 39, 40, 41}},
                             
                              {{ 14, 15, 16, 17, 18, 19, 20},
                               { 49, 50,  7, 52, 53, 54, 55},
                               { 56, 57,  8, 59, 60, 61, 62}},
                             
                              {{ 21, 22, 23, 24, 25, 26, 27},
                               { 70, 71, 10, 73, 74, 75, 76},
                               { 77, 78, 11, 80, 81, 82, 83}},
                             
                              {{ 28, 29, 30, 31, 32, 33, 34},
                               { 91, 92, 13, 94, 95, 96, 97},
                               { 98, 99, 14,101,102,103,104}}};
        EXPECT_EQ(a, py_a3);

        view(a, all(), 2, all()) = xt::arange(7);
        // py_a4
        xarray<long> py_a4 = {{{ 0, 1, 2, 3, 4, 5, 6},
                               { 7, 8, 1,10,11,12,13},
                               { 0, 1, 2, 3, 4, 5, 6}},
                             
                              {{ 7, 8, 9,10,11,12,13},
                               {28,29, 4,31,32,33,34},
                               { 0, 1, 2, 3, 4, 5, 6}},
                             
                              {{14,15,16,17,18,19,20},
                               {49,50, 7,52,53,54,55},
                               { 0, 1, 2, 3, 4, 5, 6}},
                             
                              {{21,22,23,24,25,26,27},
                               {70,71,10,73,74,75,76},
                               { 0, 1, 2, 3, 4, 5, 6}},
                             
                              {{28,29,30,31,32,33,34},
                               {91,92,13,94,95,96,97},
                               { 0, 1, 2, 3, 4, 5, 6}}};
        EXPECT_EQ(a, py_a4);
    }
}
